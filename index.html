<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">MJZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- Light Mode CSS Variables (Basis) --- */
        :root {
            --bg-primary: #f7f9fc; 
            --text-base: #1f2937;
            --text-secondary: #4b5563;
            --card-bg: white;
            --input-bg: white;
            --input-border: #d1d5db;
            --color-primary: #3b82f6; /* Blue 500 */
            --color-primary-dark: #2563eb; /* Blue 600 */
            --color-title: #1d4ed8; /* Blue 700 */
            --color-summary-bg: #eff6ff; /* Blue 50 */
            --color-summary-border: #3b82f6;
            --color-text-summary: #1d4ed8;
            --btn-quick-time-bg: #e5e7eb;
            --btn-quick-time-hover: #d1d5db;
            --color-warning: #f59e0b; /* Amber 500 */
            --color-danger: #dc2626; /* Red 600 */
            --color-success: #10b981; /* Emerald 500 */
            --color-success-dark: #059669; /* Emerald 600 */
            --logo-color-m: var(--color-primary);
            --logo-color-j: var(--color-primary-dark);
            --logo-color-z: #1e3a8a; /* Dunklerer Blauton */
            --logo-text-color: var(--text-base);
            --logo-bg: #e0f0ff; /* NEU: Sehr helles Blau für den Hintergrund */
        }

        /* --- Dark Mode Overrides (wird durch JS auf das <html> Tag angewendet) --- */
        html.dark {
            --bg-primary: #1f2937;
            --text-base: #f3f4f6;
            --text-secondary: #9ca3af;
            --card-bg: #374151;
            --input-bg: #4b5563;
            --input-border: #6b7280;
            --color-primary: #60a5fa; /* Blue 400 */
            --color-primary-dark: #3b82f6; /* Blue 500 */
            --color-title: #93c5fd; /* Blue 300 */
            --color-summary-bg: #111827; /* Gray 900 */
            --color-summary-border: #60a5fa;
            --color-text-summary: #93c5fd;
            --btn-quick-time-bg: #374151;
            --btn-quick-time-hover: #4b5563;
            --color-warning: #fcd34d; /* Amber 300 */
            --color-danger: #f87171; /* Red 400 */
            --color-success: #34d399; /* Emerald 400 */
            --color-success-dark: #10b981; /* Emerald 500 */
            --logo-color-m: #93c5fd; /* Blue 300 */
            --logo-color-j: #60a5fa; /* Blue 400 */
            --logo-color-z: #3b82f6; /* Blue 500 */
            --logo-text-color: #f3f4f6;
            --logo-bg: #1e3a8a; /* NEU: Dunkleres Blau für den Hintergrund */
        }

        /* Globale Stile */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-base);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .card {
            background-color: var(--card-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem; /* rounded-xl */
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-dark);
        }

        .input-style {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-base);
            border-radius: 0.375rem;
            padding: 0.5rem;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        
        /* Stil für den "JETZT" Button */
        .btn-now {
            background-color: #4b5563; /* Gray 600 */
            color: white;
            padding: 0.35rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem; /* text-xs */
            line-height: 1;
            font-weight: 600;
            white-space: nowrap;
            transition: background-color 0.2s;
        }

        .btn-now:hover {
            background-color: #374151; /* Gray 700 */
        }

        .summary-card {
            background-color: var(--color-summary-bg);
            border-left: 4px solid var(--color-summary-border);
            color: var(--color-text-summary);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        /* Spezifische Tabellen-Stile für bessere Lesbarkeit */
        .summary-table th {
            background-color: var(--color-summary-bg);
            color: var(--color-text-summary);
            border-bottom: 2px solid var(--color-summary-border);
            padding: 0.75rem 0.5rem;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .summary-table td {
            border-bottom: 1px solid var(--input-border);
            padding: 0.75rem 0.5rem;
            color: var(--text-base);
        }

        .summary-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Mobile Anpassungen für die Tabelle */
        @media (max-width: 768px) {
            .summary-table th, .summary-table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
            }
        }
        
        /* Custom Modal Styles (für Bestätigungen) */
        .confirm-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .confirm-modal-content {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        /* Settings Modal Styles (Vollbild auf Mobile) */
        .settings-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary); /* Passt zum App-Hintergrund */
            display: none; 
            z-index: 110; /* Höher als das Bestätigungsmodal */
            overflow-y: auto;
        }
        .settings-modal-content {
            padding: 1rem;
            height: 100%;
        }

        /* MJZ Logo-Stile */
        .mjz-logo {
            font-family: 'Inter', sans-serif;
            font-weight: 900; /* Extra bold */
            font-size: 3.5rem; /* Große Schriftgröße für das Logo */
            line-height: 0.9; /* Enger Zeilenabstand */
            display: flex; /* Für Inline-Positionierung der Buchstaben */
            position: relative; /* Wichtig, damit das Logo über dem ::before liegt */
            z-index: 1; /* Wichtig, damit das Logo über dem ::before liegt */
        }
        .mjz-logo-m { color: var(--logo-color-m); }
        .mjz-logo-j { color: var(--logo-color-j); }
        .mjz-logo-z { color: var(--logo-color-z); }
        .mjz-subtitle {
            font-size: 0.9rem; /* Kleinere Schrift für den Untertitel */
            font-weight: 500;
            color: var(--logo-text-color); /* Nutzt die neue Logo-Textfarbe */
            margin-top: 0.25rem; /* Kleiner Abstand zum Logo */
            position: relative;
            z-index: 1;
        }

        /* Container für den schrägen Hintergrund */
        .logo-container {
            position: relative;
            /* Anpassung des Paddings, um den Hintergrund einzuschließen */
            padding: 0.5rem 1rem; 
        }

        .logo-container::before {
            content: '';
            position: absolute;
            /* Hintergrund etwas größer als der Inhalt */
            top: -0.25rem; 
            left: -0.5rem;
            right: 0;
            bottom: -0.25rem;
            background: var(--logo-bg);
            /* Ovale und unregelmäßige Form */
            border-radius: 60% 40% 70% 30% / 30% 70% 30% 70%; 
            /* Schräge Transformation */
            transform: rotate(-5deg); 
            z-index: 0;
            transition: background 0.3s;
            /* Nur auf Desktop ein bisschen größer, auf Mobile kompakter */
            min-width: 150px; 
            min-height: 80px;
        }

    </style>
</head>
<body class="min-h-screen">

    

<div class="max-w-7xl mx-auto p-4 md:p-8">
        
        

<header class="mb-8 flex justify-between items-start">
            
            <div class="logo-container"> <!-- NEUER CONTAINER FÜR DEN HINTERGRUND -->
                <div class="mjz-logo">
                    <span class="mjz-logo-m">M</span><span class="mjz-logo-j">J</span><span class="mjz-logo-z">Z</span>
                </div>
                <p class="mjz-subtitle" id="headerSubtitle">Mini-Job Zeiterfassung</p>
            </div>
            
            

<button onclick="showSettingsModal()" class="p-2 rounded-full" style="color:var(--color-title); background-color: var(--card-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
        </header>

        

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            

<div class="lg:col-span-1 space-y-6">

                

<div class="card p-4 space-y-4">
                    <h2 class="text-2xl font-bold" id="cardTitleNewEntry">Neue Arbeitszeit erfassen</h2>
                    
                    

<div>
                        <label for="entryDate" class="block text-sm font-medium mb-1" id="labelDate">Datum</label>
                        <input type="date" id="entryDate" class="input-style w-full" required>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        
                        

<div>
                            <label for="entryStartTime" class="block text-sm font-medium mb-1" id="labelStart">Start</label>
                            <div class="flex items-center space-x-2">
                                <input type="time" id="entryStartTime" class="input-style w-full" required onchange="checkNextDayTime()">
                                <button onclick="setCurrentTime('entryStartTime')" class="btn-now">JETZT</button>
                            </div>
                        </div>

                        

<div>
                            <label for="entryEndTime" class="block text-sm font-medium mb-1" id="labelEnd">Ende</label>
                            <div class="flex items-center space-x-2">
                                <input type="time" id="entryEndTime" class="input-style w-full" required onchange="checkNextDayTime()">
                                <button onclick="setCurrentTime('entryEndTime')" class="btn-now">JETZT</button>
                            </div>
                            <!-- HINWEIS: Ende am nächsten Tag -->
                            <p id="nextDayHint" class="text-xs font-medium mt-1 pl-1" style="color:var(--color-primary); display: none;"></p>
                        </div>
                    </div>

                    <button onclick="addTimeEntry()" class="btn-primary w-full" id="btnAddEntry">Zeiteintrag speichern</button>
                    <div id="inputMessage" class="text-sm font-medium text-center text-red-500 hidden"></div>
                </div>

            </div>

            

<div class="lg:col-span-2 space-y-6">

                

<div class="card p-4 space-y-4">
                    <!-- ANPASSUNG: Monat und Jahr nebeneinander -->
                    <div class="flex space-x-2 items-center justify-between">
                        <!-- Monat -->
                        <select id="monthSelect" onchange="selectMonthYear()" class="input-style text-lg font-bold py-1 px-2 w-1/2"></select>
                        <!-- Jahr -->
                        <select id="yearSelect" onchange="selectMonthYear()" class="input-style text-lg font-bold py-1 px-2 w-1/2"></select>
                    </div>

                    <div class="summary-card p-4">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p class="text-xs font-semibold uppercase opacity-75" id="summaryTotalTime">Gesamtzeit (Std)</p>
                                <p class="text-2xl font-extrabold" id="totalTimeHours">0.00</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs font-semibold uppercase opacity-75" id="summaryTotalEarnings">Gesamtlohn (€)</p>
                                <p class="text-2xl font-extrabold" id="totalEarnings">0.00</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs font-semibold uppercase opacity-75" id="summaryOvertime">Überstunden (Std)</p>
                                <p class="text-2xl font-extrabold" id="overtimeHours">0.00</p>
                            </div>
                        </div>
                        <div id="minijobWarning" class="mt-4 p-2 rounded-lg text-sm font-semibold text-center" style="background-color: var(--color-warning); color: black; display:none;">
                            <span id="warningText"></span>
                        </div>
                    </div>
                </div>

                

<div class="card p-4 overflow-x-auto">
                    <h2 class="text-2xl font-bold mb-4" id="cardTitleEntries">Zeiteinträge</h2>
                    <table class="summary-table w-full border-collapse">
                        <thead>
                            <tr>
                                <th id="thDate" class="rounded-tl-lg px-2 py-2 text-left">Datum</th>
                                <th id="thStart" class="px-2 py-2 text-left">Start</th>
                                <th id="thEnd" class="px-2 py-2 text-left">Ende</th>
                                <th id="thDurationHMM" class="px-2 py-2 text-left">Dauer (H:MM)</th>
                                <th id="thDurationDecimal" class="rounded-tr-lg px-2 py-2 text-left">Dauer (Dezimal)</th>
                                <th id="thDelete" class="px-2 py-2 text-left">Löschen</th>
                            </tr>
                        </thead>
                        <tbody id="timeEntryList">
                            <tr><td colspan="6" class="text-center py-4" id="loadingMessage" style="color: var(--text-secondary);">Lade lokale Daten...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    

<div id="confirmModal" class="confirm-modal-backdrop">
        <div class="confirm-modal-content">
            <h3 id="confirmModalTitle" class="text-xl font-bold mb-4" style="color:var(--text-base);">MJZ</h3>
            <p id="confirmModalMessage" class="text-lg mb-4" style="color:var(--text-base);"></p>
            <div id="confirmModalActions" class="flex justify-end space-x-3">
                

</div>
        </div>
    </div>
    
    

<div id="settingsModal" class="settings-modal-backdrop">
        <div class="settings-modal-content">
            <header class="flex justify-between items-center mb-6 border-b pb-4" style="border-color: var(--input-border);">
                <h2 class="text-3xl font-bold" id="settingsModalTitle">Einstellungen & Tools</h2>
                <button onclick="hideSettingsModal()" class="p-2 rounded-full" style="color:var(--color-title); background-color: var(--card-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </header>
            
            <div class="space-y-6">
                
                

<div class="card p-4 space-y-4">
                    <h3 class="text-2xl font-bold" id="titleGeneralSettings">Allgemeine Einstellungen</h3>

                    

<div>
                        <label for="hourlyRate" class="block text-sm font-medium" id="labelRate">Aktueller Stundenlohn (€)</label>
                        <input type="number" id="hourlyRate" value="13.00" min="0" step="0.01" class="input-style w-full mt-1">
                    </div>

                    

<div>
                        <label for="minijobLimit" class="block text-sm font-medium" id="labelLimit">Minijob-Grenze (€)</label>
                        <input type="number" id="minijobLimit" value="538.00" min="0" step="0.01" class="input-style w-full mt-1">
                    </div>
                </div>
                
                

<div class="card p-4 space-y-4">
                    <h3 class="text-2xl font-bold" id="titleAppearanceLanguage">Erscheinungsbild & Sprache</h3>

                    

<div>
                        <label for="languageSelect" class="block text-sm font-medium" id="labelLanguage">Sprache</label>
                        <select id="languageSelect" class="input-style w-full mt-1">
                            <option value="de">Deutsch</option>
                            <option value="en">English</option>
                            <option value="fil">Filipino</option>
                        </select>
                    </div>

                    

<div>
                        <label for="themeSelect" class="block text-sm font-medium" id="labelTheme">Erscheinungsbild</label>
                        <select id="themeSelect" class="input-style w-full mt-1">
                            <option value="light" id="themeLight">Light Mode</option>
                            <option value="dark" id="themeDark">Dark Mode</option>
                        </select>
                    </div>
                </div>


                

<div class="card p-4 space-y-4">
                    <h2 class="text-2xl font-bold" id="cardTitleDataTools">Daten-Tools</h2>
                    <button onclick="exportCSV()" class="btn-primary w-full" style="background-color: var(--color-success); hover:background-color: var(--color-success-dark);" id="btnExport">Alle Einträge als CSV herunterladen</button>
                    
                    <div class="space-y-2">
                        <label for="csvFileInput" class="block text-sm font-medium" id="labelImport">CSV Import (ersetzt aktuelle Daten)</label>
                        <input type="file" id="csvFileInput" accept=".csv" class="input-style w-full" onchange="importCSV(event)">
                        <p id="importMessage" class="text-sm font-medium text-center hidden" style="color:var(--color-success);"></p>
                    </div>

                    <div class="border-t pt-4" style="border-color: var(--input-border);">
                        <h3 class="text-xl font-bold" style="color: var(--color-danger);" id="titleDangerZone">Gefahrenzone</h3>
                        <p class="text-sm mb-2" style="color: var(--text-secondary);" id="textDangerZone">Alle gespeicherten Daten werden permanent gelöscht.</p>
                        <button onclick="showConfirmModal('confirmReset')" class="btn-primary w-full" style="background-color: var(--color-danger);" id="btnReset">Alle Daten löschen</button>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <script>
        // Global variables for tracking
        let timeEntries = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentLanguage = 'de';
        let currentTheme = 'dark'; 

        // --- Mehrsprachigkeits-Daten (Text-IDs und Übersetzungen) ---
        const translations = {
            de: {
                appTitle: "MJZ",
                headerSubtitle: "Mini-Job Zeiterfassung", 
                cardTitleNewEntry: "Neue Arbeitszeit erfassen",
                labelDate: "Datum",
                labelStart: "Start",
                labelEnd: "Ende",
                btnAddEntry: "Zeiteintrag speichern",
                inputMessageError: "Ungültige Eingabe. Startzeit muss vor der Endzeit liegen oder die Dauer muss > 0 sein.",
                inputMessageOverlap: "Zeitüberschneidung. Der neue Eintrag überlappt mit einem bestehenden Eintrag.",
                settingsModalTitle: "Einstellungen & Tools",
                titleGeneralSettings: "Allgemeine Einstellungen",
                titleAppearanceLanguage: "Erscheinungsbild & Sprache",
                labelRate: "Aktueller Stundenlohn (€)",
                labelLimit: "Minijob-Grenze (€)",
                labelLanguage: "Sprache",
                labelTheme: "Erscheinungsbild",
                themeLight: "Light Mode",
                themeDark: "Dark Mode",
                cardTitleDataTools: "Daten-Tools",
                btnExport: "Alle Einträge als CSV herunterladen",
                labelImport: "CSV Import (ersetzt aktuelle Daten)",
                titleDangerZone: "Gefahrenzone",
                textDangerZone: "Alle gespeicherten Daten werden permanent gelöscht.",
                btnReset: "Alle Daten löschen",
                summaryTotalTime: "Gesamtzeit (Std)",
                summaryTotalEarnings: "Gesamtlohn (€)",
                summaryOvertime: "Überstunden (Std)",
                cardTitleEntries: "Zeiteinträge",
                loadingMessage: "Lade lokale Daten...",
                thDate: "Datum",
                thStart: "Start",
                thEnd: "Ende",
                thDurationHMM: "Dauer (H:MM)",
                thDurationDecimal: "Dauer (Dezimal)",
                thDelete: "Löschen",
                modalTitle: "Bestätigung",
                modalMessageReset: "Möchten Sie wirklich alle Daten löschen? Diese Aktion kann nicht rückgängig gemacht werden.",
                modalMessageDelete: "Möchten Sie diesen Eintrag wirklich löschen?",
                modalMessageImportSuccess: "Daten erfolgreich importiert. {count} Einträge geladen.",
                modalMessageImportError: "Fehler beim Import: Ungültiges CSV-Format oder leere Datei.",
                modalButtonConfirm: "Bestätigen",
                modalButtonCancel: "Abbrechen",
                warningText: "Minijob-Obergrenze erreicht. Überstunden werden berechnet.",
                endNextDayHint: "Ende-Zeit ist am nächsten Tag.", // NEU
                monthNames: ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"]
            },
            en: {
                appTitle: "MJZ",
                headerSubtitle: "Mini-Job Time Tracking", 
                cardTitleNewEntry: "Log New Work Time",
                labelDate: "Date",
                labelStart: "Start",
                labelEnd: "End",
                btnAddEntry: "Save Time Entry",
                inputMessageError: "Invalid input. Start time must be before end time or duration must be > 0.",
                inputMessageOverlap: "Time overlap. The new entry overlaps with an existing entry.",
                settingsModalTitle: "Settings & Tools",
                titleGeneralSettings: "General Settings",
                titleAppearanceLanguage: "Appearance & Language",
                labelRate: "Current Hourly Rate (€)",
                labelLimit: "Minijob Limit (€)",
                labelLanguage: "Language",
                labelTheme: "Appearance",
                themeLight: "Light Mode",
                themeDark: "Dark Mode",
                cardTitleDataTools: "Data Tools",
                btnExport: "Download All Entries as CSV",
                labelImport: "CSV Import (replaces current data)",
                titleDangerZone: "Danger Zone",
                textDangerZone: "All saved data will be permanently deleted.",
                btnReset: "Delete All Data",
                summaryTotalTime: "Total Time (Hrs)",
                summaryTotalEarnings: "Total Earnings (€)",
                summaryOvertime: "Overtime (Hrs)",
                cardTitleEntries: "Time Entries",
                loadingMessage: "Loading local data...",
                thDate: "Date",
                thStart: "Start",
                thEnd: "End",
                thDurationHMM: "Duration (H:MM)",
                thDurationDecimal: "Duration (Decimal)",
                thDelete: "Delete",
                modalTitle: "Confirmation",
                modalMessageReset: "Are you sure you want to delete all data? This action cannot be undone.",
                modalMessageDelete: "Are you sure you want to delete this entry?",
                modalMessageImportSuccess: "Data successfully imported. {count} entries loaded.",
                modalMessageImportError: "Import error: Invalid CSV format or empty file.",
                modalButtonConfirm: "Confirm",
                modalButtonCancel: "Cancel",
                warningText: "Minijob limit reached or exceeded. Overtime will be calculated.",
                endNextDayHint: "End time is on the next day.", // NEU
                monthNames: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
            },
            fil: {
                appTitle: "MJZ",
                headerSubtitle: "Mini-Job Pagsubaybay sa Oras", 
                cardTitleNewEntry: "Mag-log ng Bagong Oras ng Trabaho",
                labelDate: "Petsa",
                labelStart: "Simula",
                labelEnd: "Pagtatapos",
                btnAddEntry: "I-save ang Pag-log ng Oras",
                inputMessageError: "Hindi wastong input. Ang oras ng simula ay dapat bago ang oras ng pagtatapos o ang tagal ay dapat > 0.",
                inputMessageOverlap: "Oras overlap. Ang bagong entry ay umaapaw sa isang umiiral nang entry.",
                settingsModalTitle: "Mga Setting at Kasangkupan",
                titleGeneralSettings: "Pangkalahatang Mga Setting",
                titleAppearanceLanguage: "Hitsura at Wika",
                labelRate: "Kasalukuyang Rate kada Oras (€)",
                labelLimit: "Limitasyon ng Minijob (€)",
                labelLanguage: "Wika",
                labelTheme: "Hitsura",
                themeLight: "Light Mode",
                themeDark: "Dark Mode",
                cardTitleDataTools: "Mga Kasangkupan sa Data",
                btnExport: "I-download ang Lahat ng Entries bilang CSV",
                labelImport: "CSV Import (papalit sa kasalukuyang data)",
                titleDangerZone: "Danger Zone",
                textDangerZone: "Ang lahat ng naka-save na data ay permanenteng tatanggalin.",
                btnReset: "Tanggalin ang Lahat ng Data",
                summaryTotalTime: "Kabuuang Oras (Oras)",
                summaryTotalEarnings: "Kabuuang Kita (€)",
                summaryOvertime: "Overtime (Oras)",
                cardTitleEntries: "Mga Log ng Oras",
                loadingMessage: "Naglo-load ng lokal na data...",
                thDate: "Petsa",
                thStart: "Simula",
                thEnd: "Pagtatapos",
                thDurationHMM: "Tagal (H:MM)",
                thDurationDecimal: "Tagal (Desimal)",
                thDelete: "Tanggalin",
                modalTitle: "Kumpirmasyon",
                modalMessageReset: "Sigurado ka bang gusto mong tanggalin ang lahat ng data? Ang aksyon na ito ay hindi mababawi.",
                modalMessageDelete: "Sigurado ka bang gusto mong tanggalin ang entry na ito?",
                modalMessageImportSuccess: "Matagumpay na na-import ang data. {count} entries na-load.",
                modalMessageImportError: "Error sa Import: Hindi wasto ang CSV format o walang laman ang file.",
                modalButtonConfirm: "Kumpirmahin",
                modalButtonCancel: "Kanselahin",
                warningText: "Naabot o nalampasan ang limitasyon ng Minijob. Kinakalkula ang Overtime.",
                endNextDayHint: "Ang oras ng pagtatapos ay sa susunod na araw.", // NEU
                monthNames: ["Enero", "Pebrero", "Marso", "Abril", "Mayo", "Hunyo", "Hulyo", "Agosto", "Setyembre", "Oktubre", "Nobyembre", "Disyembre"]
            }
        };

        // --- Helper-Funktionen ---
        
        // Setzt die aktuelle Zeit in das angegebene Feld (Start oder Ende)
        const setCurrentTime = (inputId) => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${hours}:${minutes}`;
            
            document.getElementById(inputId).value = currentTime;
            
            // Führe die Mitternachts-Prüfung aus, nachdem die Zeit gesetzt wurde
            checkNextDayTime(); 
        };

        // Funktion zur Prüfung, ob die Endzeit am nächsten Tag liegt
        const checkNextDayTime = () => {
            const startInput = document.getElementById('entryStartTime').value;
            const endInput = document.getElementById('entryEndTime').value;
            const hintElement = document.getElementById('nextDayHint');

            if (startInput && endInput) {
                // Wenn Endzeit (HH:MM) <= Startzeit (HH:MM), liegt Ende am nächsten Tag
                if (endInput <= startInput) {
                    hintElement.textContent = translations[currentLanguage].endNextDayHint;
                    hintElement.style.display = 'block';
                } else {
                    hintElement.style.display = 'none';
                }
            } else {
                hintElement.style.display = 'none';
            }
        };

        // Funktion zum Formatieren von Minuten in H:MM (z.B. 125 -> 2:05)
        const formatDurationHMM = (minutes) => {
            const h = Math.floor(minutes / 60);
            const mm = Math.floor(minutes % 60);
            return `${h}:${mm < 10 ? '0' : ''}${mm}`;
        };

        // Funktion zum Formatieren von Minuten in Dezimalstunden (z.B. 125 -> 2.08)
        const formatDurationDecimal = (minutes) => {
            return (minutes / 60).toFixed(2);
        };

        // Funktion zur Aktualisierung aller Texte basierend auf der aktuellen Sprache
        const updateTexts = () => {
            const texts = translations[currentLanguage];
            if (!texts) return;

            // Header und statische Titel
            document.getElementById('appTitle').textContent = texts.appTitle;
            document.getElementById('headerSubtitle').textContent = texts.headerSubtitle;
            document.getElementById('cardTitleNewEntry').textContent = texts.cardTitleNewEntry;
            document.getElementById('btnAddEntry').textContent = texts.btnAddEntry;
            document.getElementById('settingsModalTitle').textContent = texts.settingsModalTitle;
            document.getElementById('titleGeneralSettings').textContent = texts.titleGeneralSettings;
            document.getElementById('titleAppearanceLanguage').textContent = texts.titleAppearanceLanguage;
            document.getElementById('cardTitleDataTools').textContent = texts.cardTitleDataTools;
            document.getElementById('btnExport').textContent = texts.btnExport;
            document.getElementById('titleDangerZone').textContent = texts.titleDangerZone;
            document.getElementById('textDangerZone').textContent = texts.textDangerZone;
            document.getElementById('btnReset').textContent = texts.btnReset;
            document.getElementById('cardTitleEntries').textContent = texts.cardTitleEntries;
            document.getElementById('loadingMessage').textContent = texts.loadingMessage;
            document.getElementById('warningText').textContent = texts.warningText;
            document.getElementById('confirmModalTitle').textContent = texts.appTitle;

            // Labels
            document.getElementById('labelDate').textContent = texts.labelDate;
            document.getElementById('labelStart').textContent = texts.labelStart;
            document.getElementById('labelEnd').textContent = texts.labelEnd;
            document.getElementById('labelRate').textContent = texts.labelRate;
            document.getElementById('labelLimit').textContent = texts.labelLimit;
            document.getElementById('labelLanguage').textContent = texts.labelLanguage;
            document.getElementById('labelTheme').textContent = texts.labelTheme;
            document.getElementById('labelImport').textContent = texts.labelImport;
            
            // Summary Labels
            document.getElementById('summaryTotalTime').textContent = texts.summaryTotalTime;
            document.getElementById('summaryTotalEarnings').textContent = texts.summaryTotalEarnings;
            document.getElementById('summaryOvertime').textContent = texts.summaryOvertime;

            // Table Headers
            document.getElementById('thDate').textContent = texts.thDate;
            document.getElementById('thStart').textContent = texts.thStart;
            document.getElementById('thEnd').textContent = texts.thEnd;
            document.getElementById('thDurationHMM').textContent = texts.thDurationHMM;
            document.getElementById('thDurationDecimal').textContent = texts.thDurationDecimal;
            document.getElementById('thDelete').textContent = texts.thDelete;

            // Theme Options
            document.getElementById('themeLight').textContent = texts.themeLight;
            document.getElementById('themeDark').textContent = texts.themeDark;
            
            // Da die Monatsnamen übersetzt wurden, muss die Tabelle und die Monatsauswahl neu gerendert werden
            renderTimeEntries();
            
            // Überprüfe auch den Mitternachts-Hinweis, falls Zeiten schon gesetzt sind
            checkNextDayTime();
        };

        // Funktion zur Speicherung der Einträge im LocalStorage
        const saveEntries = () => {
            localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
            renderTimeEntries();
        };

        // Funktion zum Laden der Einträge und Einstellungen aus dem LocalStorage
        const loadData = () => {
            const today = new Date();
            
            // --- 1. Datums- und Monats-/Jahres-Defaults setzen ---
            // WICHTIG: Setzt die globalen Variablen IMMER auf heute
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            
            // Setzt das Datum-Inputfeld auf heute (YYYY-MM-DD Format)
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('entryDate').value = todayStr;

            // --- 2. Einträge laden ---
            const savedEntries = localStorage.getItem('timeEntries');
            if (savedEntries) {
                timeEntries = JSON.parse(savedEntries);
                // Sicherstellen, dass jeder Eintrag eine Rate hat
                const defaultRate = parseFloat(localStorage.getItem('hourlyRate')) || 13.00;
                timeEntries = timeEntries.map(entry => {
                    // Fügt die Rate hinzu, falls sie fehlt (für Legacy-Einträge)
                    if (typeof entry.rate === 'undefined') {
                         entry.rate = defaultRate;
                    }
                    // Entfernt alte breaksMinutes
                    const { breaksMinutes, ...rest } = entry;
                    return rest;
                });
                timeEntries.sort((a, b) => new Date(a.date + ' ' + a.start) - new Date(b.date + ' ' + b.start));
            }

            // --- 3. Einstellungen laden ---
            const savedRate = localStorage.getItem('hourlyRate');
            if (savedRate) document.getElementById('hourlyRate').value = savedRate;

            const savedLimit = localStorage.getItem('minijobLimit');
            if (savedLimit) document.getElementById('minijobLimit').value = savedLimit;

            const savedLang = localStorage.getItem('language');
            if (savedLang && translations[savedLang]) {
                currentLanguage = savedLang;
                document.getElementById('languageSelect').value = savedLang;
            }

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme && (savedTheme === 'light' || savedTheme === 'dark')) {
                currentTheme = savedTheme;
            } else {
                currentTheme = 'dark'; // Default auf dark setzen
            }
            document.getElementById('themeSelect').value = currentTheme;
            
            applyTheme(currentTheme);
            updateTexts(); // Ruft renderTimeEntries auf
        };

        // Funktion zur Anwendung des ausgewählten Themas
        const applyTheme = (theme) => {
            const html = document.documentElement;
            // Entferne alle themenbezogenen Klassen, außer 'dark'
            html.classList.remove('dark');

            // Wende Dark Mode nur an, wenn explizit 'dark' gewählt
            if (theme === 'dark') {
                html.classList.add('dark');
            }
            
            localStorage.setItem('theme', theme);
            currentTheme = theme;
        };

        // Funktion zum Befüllen der Monats- und Jahr-Dropdowns
        const populateMonthYearSelects = () => {
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            const texts = translations[currentLanguage];

            // 1. Monats-Dropdown befüllen
            monthSelect.innerHTML = '';
            texts.monthNames.forEach((monthName, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = monthName;
                monthSelect.appendChild(option);
            });

            // 2. Jahres-Dropdown befüllen
            yearSelect.innerHTML = '';
            const todayYear = new Date().getFullYear();
            let minYear = todayYear;

            if (timeEntries.length > 0) {
                // Finde das älteste Jahr in den Einträgen
                timeEntries.forEach(entry => {
                    const year = parseInt(entry.date.split('-')[0]);
                    if (year < minYear) {
                        minYear = year;
                    }
                });
            }
            
            // Füge Jahre von heute + 1 bis zum ältesten Eintrag hinzu
            for (let year = todayYear + 1; year >= minYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            // 3. Dropdowns auf die aktuellen Werte setzen
            // WICHTIG: Diese Werte kommen aus den globalen Variablen, die in loadData
            // IMMER auf das aktuelle Datum gesetzt wurden.
            monthSelect.value = currentMonth;
            yearSelect.value = currentYear;
        };

        // Funktion zum Ändern des angezeigten Monats und Jahres über die Dropdowns
        const selectMonthYear = () => {
            currentMonth = parseInt(document.getElementById('monthSelect').value);
            currentYear = parseInt(document.getElementById('yearSelect').value);
            renderTimeEntries();
        };


        // Funktion zur Berechnung und Darstellung der Monatsübersicht und Tabelle
        const renderTimeEntries = () => {
            const entryList = document.getElementById('timeEntryList');
            entryList.innerHTML = '';
            
            // Dropdowns befüllen und initialisieren
            populateMonthYearSelects();

            const currentMinijobLimit = parseFloat(document.getElementById('minijobLimit').value) || 0;
            
            // Filtern der Einträge für den aktuell ausgewählten Monat/Jahr
            const filteredEntries = timeEntries.filter(entry => {
                const parts = entry.date.split('-');
                // Erstellt ein lokales Date-Objekt: new Date(year, monthIndex, day)
                const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));

                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            

            if (filteredEntries.length === 0) {
                entryList.innerHTML = `<tr><td colspan="6" class="text-center py-4" style="color: var(--text-secondary);">${translations[currentLanguage].loadingMessage}</td></tr>`;
                document.getElementById('totalTimeHours').textContent = '0.00';
                document.getElementById('totalEarnings').textContent = '0.00';
                document.getElementById('overtimeHours').textContent = '0.00';
                document.getElementById('minijobWarning').style.display = 'none';
                return;
            }

            // --- Berechnung der Gesamtwerte für den Monat (mit Kappung) ---
            
            let monthlyTotalMinutes = 0;
            let overtimeHours = 0;
            let cumulativeEarnings = 0;

            const chronologicalEntries = [...filteredEntries].sort((a, b) => new Date(a.date + ' ' + a.start) - new Date(b.date + ' ' + b.start));

            for (const entry of chronologicalEntries) {
                const totalMinutes = entry.durationMinutes; 
                const decimalHours = totalMinutes / 60;
                // Jetzt wird die festgeschriebene Rate des Eintrags verwendet (entry.rate)
                const entryRate = entry.rate || 0; 
                
                let paidEarnings = 0;
                let hoursOverLimit = 0;
                
                if (entryRate > 0) { 
                    if (cumulativeEarnings < currentMinijobLimit) {
                        const remainingLimit = currentMinijobLimit - cumulativeEarnings;
                        const potentialEarnings = decimalHours * entryRate;

                        if (cumulativeEarnings + potentialEarnings <= currentMinijobLimit) {
                            paidEarnings = potentialEarnings;
                            cumulativeEarnings += paidEarnings;
                        } else {
                            paidEarnings = remainingLimit;
                            cumulativeEarnings = currentMinijobLimit;
                            
                            const hoursToLimit = remainingLimit / entryRate;
                            hoursOverLimit = decimalHours - hoursToLimit;
                        }
                    } else {
                        hoursOverLimit = decimalHours;
                    }
                } else {
                    // Wenn Rate 0 ist, wird nichts bezahlt, alles zählt als "Überstunde" (nicht bezahlte Zeit)
                    hoursOverLimit = decimalHours; 
                }


                overtimeHours += hoursOverLimit;
                monthlyTotalMinutes += totalMinutes;

                // Tabellenzeile erstellen (für gefilterte Einträge)
                const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'UTC' };
                // Das Date-Objekt für die Anzeige muss aus den lokalen Datumsteilen erstellt werden, um die Zeitzonenverschiebung zu verhindern.
                const parts = entry.date.split('-');
                const displayDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));

                const dateStr = displayDate.toLocaleDateString(currentLanguage, dateOptions);

                const newRow = entryList.insertRow();
                newRow.className = 'hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150';
                
                newRow.insertCell().textContent = dateStr;
                newRow.insertCell().textContent = entry.start;
                newRow.insertCell().textContent = entry.end;
                
                newRow.insertCell().textContent = formatDurationHMM(totalMinutes);
                newRow.insertCell().textContent = formatDurationDecimal(totalMinutes);

                // Löschen-Button
                const deleteCell = newRow.insertCell();
                deleteCell.className = 'text-center';
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = translations[currentLanguage].thDelete;
                deleteBtn.className = 'text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-semibold text-sm transition-colors';
                deleteBtn.onclick = () => showConfirmModal('confirmDelete', entry.id);
                deleteCell.appendChild(deleteBtn);
            }

            // --- Monats-Summary aktualisieren ---
            
            const totalEarnings = cumulativeEarnings.toFixed(2);
            const totalTimeHours = formatDurationDecimal(monthlyTotalMinutes);
            const totalOvertime = overtimeHours.toFixed(2);

            document.getElementById('totalTimeHours').textContent = totalTimeHours;
            document.getElementById('totalEarnings').textContent = totalEarnings;
            document.getElementById('overtimeHours').textContent = totalOvertime;

            // Warnung anzeigen, wenn das Limit erreicht ist
            if (cumulativeEarnings >= currentMinijobLimit && currentMinijobLimit > 0) {
                document.getElementById('minijobWarning').style.display = 'block';
            } else {
                document.getElementById('minijobWarning').style.display = 'none';
            }
        };

        // Hilfsfunktion zur Prüfung auf Überschneidungen
        const checkOverlap = (newStart, newEnd) => {
            for (const existingEntry of timeEntries) {
                // Erstelle Start- und End-Timestamps in Millisekunden für den Vergleich
                const existingStart = new Date(`${existingEntry.date}T${existingEntry.start}:00`).getTime();
                let existingEnd = new Date(`${existingEntry.date}T${existingEntry.end}:00`).getTime();
                
                // Behandle Einträge, die über Mitternacht gehen (Ende ist am nächsten Tag)
                if (existingEnd <= existingStart) {
                    existingEnd += (24 * 60 * 60 * 1000); // 1 Tag hinzufügen
                }

                // Prüfen auf Überschneidung:
                // Überschneidung, wenn (Astart < Bend) UND (Bstart < Aend)
                // Hier: (newStart < existingEnd) UND (existingStart < newEnd)
                if (newStart < existingEnd && existingStart < newEnd) {
                    return true; // Überschneidung gefunden
                }
            }
            return false; // Keine Überschneidung
        }

        // Funktion zum Hinzufügen eines neuen Zeiteintrags
        const addTimeEntry = () => {
            const dateInput = document.getElementById('entryDate').value;
            const startInput = document.getElementById('entryStartTime').value;
            const endInput = document.getElementById('entryEndTime').value;

            const messageBox = document.getElementById('inputMessage');
            messageBox.textContent = '';
            messageBox.classList.add('hidden');
            
            // Verstecke den Mitternachts-Hinweis, da er bei einer erfolgreichen Speicherung
            // oder einem Fehler nicht mehr benötigt wird.
            document.getElementById('nextDayHint').style.display = 'none';

            if (!dateInput || !startInput || !endInput) {
                messageBox.textContent = translations[currentLanguage].inputMessageError;
                messageBox.classList.remove('hidden');
                return;
            }

            const startDateTime = new Date(`${dateInput}T${startInput}:00`);
            let endDateTime = new Date(`${dateInput}T${endInput}:00`);
            
            const isNextDay = endDateTime <= startDateTime;
            if (isNextDay) {
                endDateTime.setDate(endDateTime.getDate() + 1);
            }

            const durationMs = endDateTime - startDateTime;
            const durationMinutes = Math.max(0, Math.round(durationMs / (1000 * 60)));

            if (durationMinutes <= 0) {
                messageBox.textContent = translations[currentLanguage].inputMessageError;
                messageBox.classList.remove('hidden');
                return;
            }

            // NEUE ÜBERSCHNEIDUNGSPRÜFUNG
            const newEntryStartMs = startDateTime.getTime();
            const newEntryEndMs = endDateTime.getTime();

            if (checkOverlap(newEntryStartMs, newEntryEndMs)) {
                messageBox.textContent = translations[currentLanguage].inputMessageOverlap;
                messageBox.classList.remove('hidden');
                return;
            }

            // Stundenlohn beim Speichern fixieren
            const currentHourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;

            const newEntry = {
                id: Date.now(), 
                date: dateInput,
                start: startInput,
                end: endInput,
                durationMinutes: durationMinutes,
                rate: currentHourlyRate // Fixiere den aktuellen Stundenlohn
            };

            timeEntries.push(newEntry);
            timeEntries.sort((a, b) => new Date(a.date + ' ' + a.start) - new Date(b.date + ' ' + b.start));
            
            // Setze den aktuellen Monat und das Jahr auf den neu erfassten Eintrag
            // WICHTIG: Überschreiben der Auswahl, um den Nutzer im Kontext zu halten
            currentMonth = startDateTime.getMonth();
            currentYear = startDateTime.getFullYear();

            saveEntries();

            document.getElementById('entryStartTime').value = '';
            document.getElementById('entryEndTime').value = '';

            document.getElementById('entryStartTime').focus();
        };

        // Funktion zum Löschen eines Eintrags
        const deleteEntry = (id) => {
            timeEntries = timeEntries.filter(entry => entry.id !== id);
            saveEntries();
        };

        // --- Modal- und Confirmation-Logik ---

        const confirmModal = document.getElementById('confirmModal');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmModalActions = document.getElementById('confirmModalActions');
        const settingsModal = document.getElementById('settingsModal');

        // Zeigt das Custom-Modal (Bestätigungen) an
        const showConfirmModal = (type, data = null) => {
            confirmModalActions.innerHTML = '';
            
            let confirmAction;

            if (type === 'confirmReset') {
                confirmModalMessage.textContent = translations[currentLanguage].modalMessageReset;
                confirmAction = resetData;
            } else if (type === 'confirmDelete') {
                confirmModalMessage.textContent = translations[currentLanguage].modalMessageDelete;
                confirmAction = () => deleteEntry(data);
            } else if (type === 'importSuccess') {
                confirmModalMessage.textContent = translations[currentLanguage].modalMessageImportSuccess.replace('{count}', data);
            } else if (type === 'importError') {
                confirmModalMessage.textContent = translations[currentLanguage].modalMessageImportError;
            }

            // Erstelle Abbrechen-Button (nur bei Reset/Delete)
            if (type === 'confirmReset' || type === 'confirmDelete') {
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = translations[currentLanguage].modalButtonCancel;
                cancelBtn.className = 'py-2 px-4 rounded-lg font-semibold border transition-colors';
                cancelBtn.style.cssText = 'background-color: var(--input-bg); color: var(--text-base); border-color: var(--input-border);';
                cancelBtn.onclick = hideConfirmModal;
                confirmModalActions.appendChild(cancelBtn);
            }

            // Erstelle Bestätigen/OK Button
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = (type === 'confirmReset' || type === 'confirmDelete') ? translations[currentLanguage].modalButtonConfirm : 'OK';
            confirmBtn.className = 'btn-primary';
            confirmBtn.onclick = () => {
                if (confirmAction) confirmAction();
                hideConfirmModal();
            };
            // Bei Reset/Delete: rote Farbe verwenden
            if (type === 'confirmReset' || type === 'confirmDelete') {
                confirmBtn.style.cssText = `background-color: var(--color-danger);`;
            }

            confirmModalActions.appendChild(confirmBtn);

            confirmModal.style.display = 'flex';
        };

        // Versteckt das Custom-Modal
        const hideConfirmModal = () => {
            confirmModal.style.display = 'none';
        };
        
        // Zeigt das Settings-Modal an (als Vollbild)
        const showSettingsModal = () => {
            settingsModal.style.display = 'flex';
        };
        
        // Versteckt das Settings-Modal
        const hideSettingsModal = () => {
            settingsModal.style.display = 'none';
        };

        // Funktion zum Zurücksetzen aller Daten
        const resetData = () => {
            localStorage.removeItem('timeEntries');
            localStorage.removeItem('hourlyRate');
            localStorage.removeItem('minijobLimit');
            timeEntries = [];
            document.getElementById('hourlyRate').value = '13.00';
            document.getElementById('minijobLimit').value = '538.00';
            
            loadData(); // Lade alles neu mit aktuellen Defaults
        };

        // --- CSV-Logik ---
        
        const csvHeader = ["ID", "Datum", "Startzeit", "Endzeit", "DauerMinuten", "RateEUR"];

        // Funktion zum Export der Einträge als CSV
        const exportCSV = () => {
            if (timeEntries.length === 0) return;

            const csvData = timeEntries.map(entry => [
                entry.id,
                entry.date,
                entry.start,
                entry.end,
                entry.durationMinutes,
                // Nutze die festgeschriebene Rate des Eintrags
                (entry.rate || 0).toFixed(2) 
            ]);

            const csvArray = [csvHeader, ...csvData];
            const csvString = csvArray.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });

            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            
            const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            link.setAttribute("download", `MJZ_Export_${today}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Funktion zum Importieren von CSV-Daten
        const importCSV = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvString = e.target.result;
                const lines = csvString.split('\n').filter(line => line.trim() !== '');

                if (lines.length <= 1) {
                    showConfirmModal('importError');
                    return;
                }
                
                const importedEntries = [];
                const header = lines[0].split(',');
                
                // Wir erwarten mindestens 6 Felder (ID, Datum, Start, Ende, Dauer, Rate)
                if (header.length < 6) { 
                    showConfirmModal('importError');
                    return;
                }

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length >= 6) { 
                        
                        const entry = {
                            id: parseInt(values[0], 10) || Date.now() + i, 
                            date: values[1],
                            start: values[2],
                            end: values[3],
                            durationMinutes: parseInt(values[4], 10) || 0,
                            // Lese Rate aus der CSV, wenn vorhanden, sonst Standardwert
                            rate: parseFloat(values[5]) || parseFloat(document.getElementById('hourlyRate').value) || 0 
                        };
                        
                        if (entry.date && entry.start && entry.end && entry.durationMinutes > 0) {
                            importedEntries.push(entry);
                        }
                    }
                    else {
                        console.warn(`Skipping malformed CSV line ${i}: ${lines[i]}`);
                    }
                }

                if (importedEntries.length > 0) {
                    timeEntries = importedEntries;
                    saveEntries();
                    showConfirmModal('importSuccess', importedEntries.length);
                } else {
                    showConfirmModal('importError');
                }
            };
            reader.readAsText(file);
            document.getElementById('csvFileInput').value = ''; // Input zurücksetzen
        };

        // --- Event Listeners und Initialisierung ---

        // Listener für die Einstellungen (Rate, Limit, Sprache, Theme)
        document.getElementById('hourlyRate').addEventListener('change', () => {
            // Rate wird nur für NEUE Einträge verwendet. Speichern für zukünftige Verwendung.
            localStorage.setItem('hourlyRate', document.getElementById('hourlyRate').value);
            renderTimeEntries(); // Neu rendern, da das Limit oder die Berechnung der Überstunden betroffen sein könnte
        });
        document.getElementById('minijobLimit').addEventListener('change', () => {
            localStorage.setItem('minijobLimit', document.getElementById('minijobLimit').value);
            renderTimeEntries();
        });
        
        document.getElementById('languageSelect').addEventListener('change', (e) => {
            currentLanguage = e.target.value;
            localStorage.setItem('language', currentLanguage);
            updateTexts(); // Ruft renderTimeEntries auf
        });
        
        document.getElementById('themeSelect').addEventListener('change', (e) => {
            applyTheme(e.target.value);
        });
        
        // Starte die App
        window.onload = loadData;
    </script>
</body>
</html>
