<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">MJZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- Light Mode CSS Variables (Basis) --- */
        :root {
            --bg-primary: #f7f9fc; 
            --text-base: #1f2937;
            --text-secondary: #4b5563;
            --card-bg: white;
            --input-bg: white;
            --input-border: #d1d5db;
            --color-primary: #3b82f6; /* Blue 500 */
            --color-primary-dark: #2563eb; /* Blue 600 */
            --color-title: #1d4ed8; /* Blue 700 */
            --color-summary-bg: #eff6ff; /* Blue 50 */
            --color-summary-border: #3b82f6;
            --color-text-summary: #1d4ed8;
            --btn-quick-time-bg: #e5e7eb;
            --btn-quick-time-hover: #d1d5db;
            --color-warning: #f59e0b; /* Amber 500 */
            --color-danger: #dc2626; /* Red 600 */
            --color-danger-dark: #b91c1c; /* Red 700 */
            --color-success: #10b981; /* Emerald 500 (Grün) */
            --color-success-dark: #059669; /* Emerald 600 */
            --color-import: #9333ea; /* Violet 600 (Violett) */
            --color-import-dark: #7e22ce; /* Violet 700 */
            --logo-color-m: var(--color-primary);
            --logo-color-j: var(--color-primary-dark);
            --logo-color-z: #1e3a8a; /* Dunklerer Blauton */
            --logo-text-color: var(--text-base);
            --logo-bg: #e0f0ff; 
        }

        /* --- Dark Mode Overrides (wird durch JS auf das <html> Tag angewendet) --- */
        html.dark {
            --bg-primary: #1f2937;
            --text-base: #f3f4f6;
            --text-secondary: #9ca3af;
            --card-bg: #374151;
            --input-bg: #4b5563;
            --input-border: #6b7280;
            --color-primary: #60a5fa; /* Blue 400 */
            --color-primary-dark: #3b82f6; /* Blue 500 */
            --color-title: #93c5fd; /* Blue 300 */
            --color-summary-bg: #111827; /* Gray 900 */
            --color-summary-border: #60a5fa;
            --color-text-summary: #93c5fd;
            --btn-quick-time-bg: #374151;
            --btn-quick-time-hover: #4b5563;
            --color-warning: #fcd34d; /* Amber 300 */
            --color-danger: #f87171; /* Red 400 */
            --color-danger-dark: #ef4444; /* Red 500 */
            --color-success: #34d399; /* Emerald 400 */
            --color-success-dark: #10b981; /* Emerald 500 */
            --color-import: #c084fc; /* Violet 400 */
            --color-import-dark: #a855f7; /* Violet 500 */
            --logo-color-m: #93c5fd; /* Blue 300 */
            --logo-color-j: #60a5fa; /* Blue 400 */
            --logo-color-z: #3b82f6; /* Blue 500 */
            --logo-text-color: #f3f4f6;
            --logo-bg: #1e3a8a; 
        }

        /* Globale Stile */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-base);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .card {
            background-color: var(--card-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem; /* rounded-xl */
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        /* Allgemeine Button-Klasse für primary-style */
        .btn-primary {
            color: white;
            padding: 0.75rem 1rem; /* Größerer Touch-Target */
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            text-align: center;
        }
        
        /* Spezifische Button-Varianten */
        .btn-default {
            background-color: var(--color-primary);
        }
        .btn-default:hover {
            background-color: var(--color-primary-dark);
        }

        .btn-success {
            background-color: var(--color-success);
        }
        .btn-success:hover {
            background-color: var(--color-success-dark);
        }

        .btn-import {
            background-color: var(--color-import);
        }
        .btn-import:hover:not(:disabled) {
            background-color: var(--color-import-dark);
        }
        
        .btn-danger {
            background-color: var(--color-danger);
        }
        .btn-danger:hover {
            background-color: var(--color-danger-dark);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        

        .input-style {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-base);
            border-radius: 0.375rem;
            padding: 0.5rem;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        
        /* Stil für den "JETZT" Button */
        .btn-now {
            background-color: #4b5563; /* Gray 600 */
            color: white;
            padding: 0.35rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem; /* text-xs */
            line-height: 1;
            font-weight: 600;
            white-space: nowrap;
            transition: background-color 0.2s;
        }

        .btn-now:hover {
            background-color: #374151; /* Gray 700 */
        }

        .summary-card {
            background-color: var(--color-summary-bg);
            border-left: 4px solid var(--color-summary-border);
            color: var(--color-text-summary);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        /* Spezifische Tabellen-Stile für bessere Lesbarkeit */
        .summary-table th {
            background-color: var(--color-summary-bg);
            color: var(--color-text-summary);
            border-bottom: 2px solid var(--color-summary-border);
            padding: 0.75rem 0.5rem;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .summary-table td {
            border-bottom: 1px solid var(--input-border);
            padding: 0.75rem 0.5rem;
            color: var(--text-base);
        }

        .summary-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Mobile Anpassungen für die Tabelle */
        @media (max-width: 768px) {
            .summary-table th, .summary-table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
            }
        }
        
        /* Settings Modal Styles (Vollbild auf Mobile) */
        .settings-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary); /* Passt zum App-Hintergrund */
            display: none; 
            z-index: 110; 
            overflow-y: auto;
        }
        .settings-modal-content {
            padding: 1rem;
            height: 100%;
        }

        /* MJZ Logo-Stile */
        .mjz-logo {
            font-family: 'Inter', sans-serif;
            font-weight: 900; /* Extra bold */
            font-size: 3.5rem; /* Große Schriftgröße für das Logo */
            line-height: 0.9; /* Enger Zeilenabstand */
            display: flex; /* Für Inline-Positionierung der Buchstaben */
            position: relative; /* Wichtig, damit das Logo über dem ::before liegt */
            z-index: 1; /* Wichtig, damit das Logo über dem ::before liegt */
        }
        .mjz-logo-m { color: var(--logo-color-m); }
        .mjz-logo-j { color: var(--logo-color-j); }
        .mjz-logo-z { color: var(--logo-color-z); }
        .mjz-subtitle {
            font-size: 0.9rem; /* Kleinere Schrift für den Untertitel */
            font-weight: 500;
            color: var(--logo-text-color); /* Nutzt die neue Logo-Textfarbe */
            margin-top: 0.25rem; /* Kleiner Abstand zum Logo */
            position: relative;
            z-index: 1;
        }

        /* Container für den schrägen Hintergrund */
        .logo-container {
            position: relative;
            /* Anpassung des Paddings, um den Hintergrund einzuschließen */
            padding: 0.5rem 1rem; 
        }

        .logo-container::before {
            content: '';
            position: absolute;
            /* Hintergrund etwas größer als der Inhalt */
            top: -0.25rem; 
            left: -0.5rem;
            right: 0;
            bottom: -0.25rem;
            background: var(--logo-bg);
            /* Ovale und unregelmäßige Form */
            border-radius: 60% 40% 70% 30% / 30% 70% 30% 70%; 
            /* Schräge Transformation */
            transform: rotate(-5deg); 
            z-index: 0;
            transition: background 0.3s;
            /* Nur auf Desktop ein bisschen größer, auf Mobile kompakter */
            min-width: 150px; 
            min-height: 80px;
        }

    </style>
    <!-- CRITICAL FIX: Synchronous script in <head> to prevent FOUT (Flash of Wrong Theme) -->
    <script>
        (function() {
            // Versucht, das gespeicherte Thema aus dem LocalStorage abzurufen
            const savedTheme = localStorage.getItem('theme');
            
            // Definiert das Standardthema, falls nichts gespeichert ist
            let themeToApply = 'dark'; 

            if (savedTheme === 'light' || savedTheme === 'dark') {
                themeToApply = savedTheme;
            }

            // Wendet die 'dark'-Klasse sofort auf das <html>-Tag an
            if (themeToApply === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="min-h-screen">

    

<div class="max-w-7xl mx-auto p-4 md:p-8">
        
        

<header class="mb-8 flex justify-between items-start">
            
            <div class="logo-container"> <!-- Container for the slanted background -->
                <div class="mjz-logo">
                    <span class="mjz-logo-m">M</span><span class="mjz-logo-j">J</span><span class="mjz-logo-z">Z</span>
                </div>
                <p class="mjz-subtitle" id="headerSubtitle">Mini-Job Zeiterfassung</p>
            </div>
            
            

<button onclick="showSettingsModal()" class="p-2 rounded-full" style="color:var(--color-title); background-color: var(--card-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
        </header>

        

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            

<div class="lg:col-span-1 space-y-6">

                

<div class="card p-4 space-y-4">
                    <h2 class="text-2xl font-bold" id="cardTitleNewEntry">Neue Arbeitszeit erfassen</h2>
                    
                    

<div>
                        <label for="entryDate" class="block text-sm font-medium mb-1" id="labelDate">Datum</label>
                        <input type="date" id="entryDate" class="input-style w-full" required>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        
                        

<div>
                            <label for="entryStartTime" class="block text-sm font-medium mb-1" id="labelStart">Start</label>
                            <div class="flex items-center space-x-2">
                                <input type="time" id="entryStartTime" class="input-style w-full" required oninput="checkOverMidnight()">
                                <button onclick="setCurrentTime('entryStartTime'); checkOverMidnight()" class="btn-now">JETZT</button>
                            </div>
                        </div>

                        

<div>
                            <label for="entryEndTime" class="block text-sm font-medium mb-1" id="labelEnd">Ende</label>
                            <div class="flex items-center space-x-2">
                                <input type="time" id="entryEndTime" class="input-style w-full" required oninput="checkOverMidnight()">
                                <button onclick="setCurrentTime('entryEndTime'); checkOverMidnight()" class="btn-now">JETZT</button>
                            </div>
                            <!-- WARNING TEXT FOR MIDNIGHT CROSSING -->
                            <p id="nextDayWarning" class="text-xs mt-1 italic hidden" style="color: var(--color-warning);"></p>
                        </div>
                    </div>

                    <button onclick="addTimeEntry()" class="btn-primary btn-default w-full" id="btnAddEntry">Zeiteintrag speichern</button>
                    <div id="inputMessage" class="text-sm font-medium text-center text-red-500 hidden"></div>
                </div>

            </div>

            

<div class="lg:col-span-2 space-y-6">

                

<div class="card p-4 space-y-4">
                    <!-- Adjustment: Month and Year side-by-side -->
                    <div class="flex space-x-2 items-center justify-between">
                        <!-- Month -->
                        <select id="monthSelect" onchange="selectMonthYear()" class="input-style text-lg font-bold py-1 px-2 w-1/2"></select>
                        <!-- Year -->
                        <select id="yearSelect" onchange="selectMonthYear()" class="input-style text-lg font-bold py-1 px-2 w-1/2"></select>
                    </div>

                    <div class="summary-card p-4">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p class="text-xs font-semibold uppercase opacity-75" id="summaryTotalTime">Gesamtzeit (Std)</p>
                                <p class="text-2xl font-extrabold" id="totalTimeHours">0.00</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs font-semibold uppercase opacity-75" id="summaryTotalEarnings">Gesamtlohn (€)</p>
                                <p class="text-2xl font-extrabold" id="totalEarnings">0.00</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs font-semibold uppercase opacity-75" id="summaryOvertime">Überstunden (Std)</p>
                                <p class="text-2xl font-extrabold" id="overtimeHours">0.00</p>
                            </div>
                        </div>
                        <div id="minijobWarning" class="mt-4 p-2 rounded-lg text-sm font-semibold text-center" style="background-color: var(--color-warning); color: black; display:none;">
                            <span id="warningText"></span>
                        </div>
                    </div>
                </div>

                

<div class="card p-4 overflow-x-auto">
                    <h2 class="text-2xl font-bold mb-4" id="cardTitleEntries">Zeiteinträge</h2>
                    <table class="summary-table w-full border-collapse">
                        <thead>
                            <tr>
                                <th id="thDate" class="rounded-tl-lg px-2 py-2 text-left">Datum</th>
                                <th id="thStart" class="px-2 py-2 text-left">Start</th>
                                <th id="thEnd" class="px-2 py-2 text-left">Ende</th>
                                <th id="thDurationHMM" class="px-2 py-2 text-left">Dauer (H:MM)</th>
                                <th id="thDurationDecimal" class="rounded-tr-lg px-2 py-2 text-left">Dauer (Dezimal)</th>
                                <th id="thDelete" class="px-2 py-2 text-left">Löschen</th>
                            </tr>
                        </thead>
                        <tbody id="timeEntryList">
                            <tr><td colspan="6" class="text-center py-4" id="loadingMessage" style="color: var(--text-secondary);">Lade lokale Daten...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    
    

<div id="settingsModal" class="settings-modal-backdrop">
        <div class="settings-modal-content">
            <header class="flex justify-between items-center mb-6 border-b pb-4" style="border-color: var(--input-border);">
                <h2 class="text-3xl font-bold" id="settingsModalTitle">Einstellungen & Tools</h2>
                <button onclick="hideSettingsModal()" class="p-2 rounded-full" style="color:var(--color-title); background-color: var(--card-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </header>
            
            <div class="space-y-6">
                
                

<div class="card p-4 space-y-4">
                    <h3 class="text-2xl font-bold" id="titleGeneralSettings">Allgemeine Einstellungen</h3>

                    

<div>
                        <label for="hourlyRate" class="block text-sm font-medium" id="labelRate">Aktueller Stundenlohn (€)</label>
                        <input type="number" id="hourlyRate" min="0" step="0.01" class="input-style w-full mt-1" placeholder="z.B. 13.00">
                    </div>

                    

<div>
                        <label for="minijobLimit" class="block text-sm font-medium" id="labelLimit">Minijob-Verdienstobergrenze (€)</label>
                        <input type="number" id="minijobLimit" min="0" step="0.01" class="input-style w-full mt-1" placeholder="z.B. 538.00">
                    </div>
                </div>
                
                

<div class="card p-4 space-y-4">
                    <h3 class="text-2xl font-bold" id="titleAppearanceLanguage">Erscheinungsbild & Sprache</h3>

                    

<div>
                        <label for="languageSelect" class="block text-sm font-medium" id="labelLanguage">Sprache</label>
                        <select id="languageSelect" class="input-style w-full mt-1">
                            <option value="de">Deutsch</option>
                            <option value="en">English</option>
                            <option value="fil">Filipino</option>
                        </select>
                    </div>

                    

<div>
                        <label for="themeSelect" class="block text-sm font-medium" id="labelTheme">Erscheinungsbild</label>
                        <select id="themeSelect" class="input-style w-full mt-1">
                            <option value="light" id="themeLight">Light Mode</option>
                            <option value="dark" id="themeDark">Dark Mode</option>
                        </select>
                    </div>
                </div>


                

<div class="card p-4 space-y-4">
                    <h2 class="text-2xl font-bold" id="cardTitleDataTools">Daten-Tools</h2>
                    <!-- GREEN BUTTON for Export. Note: exportCSV is now globally assigned -->
                    <button onclick="exportCSV()" class="btn-primary btn-success w-full" id="btnExport">Alle Einträge als CSV herunterladen</button>
                    
                    <div class="space-y-2">
                        <label for="csvFileInput" class="block text-sm font-medium" id="labelImport">CSV Import (ersetzt aktuelle Daten)</label>
                        <div class="flex space-x-2">
                            <!-- Note: handleFileSelection is now globally assigned -->
                            <input type="file" id="csvFileInput" accept=".csv" class="input-style w-full" onchange="handleFileSelection(event)">
                            <!-- VIOLET BUTTON for Import, initial disabled. Note: importCSV is now globally assigned -->
                            <button id="btnImportAction" onclick="importCSV()" class="btn-primary btn-import" disabled>Importieren</button>
                        </div>
                        <p id="importMessage" class="text-sm font-medium text-center mt-2 hidden" style=""></p>
                    </div>

                    <!-- DANGER ZONE: Delete All Data -->
                    <div class="mt-6 border-t pt-4" style="border-color: var(--input-border);">
                        <h3 class="text-xl font-bold mb-3 text-red-600 dark:text-red-400" id="titleDangerZone">Gefahrenzone</h3>
                        
                        <!-- FIX: Delete confirmation removed. Directly call deleteAllTimeEntries() -->
                        <button onclick="deleteAllTimeEntries()" class="btn-primary btn-danger w-full" id="btnDeleteAllData">Alle Zeiteinträge löschen</button>
                        <p class="text-xs text-red-400 dark:text-red-300 italic mt-2 text-center" id="warningDeleteImmediate">Achtung: Dieser Vorgang löscht alle Einträge sofort und unwiderruflich!</p>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <!-- Custom Modal / Confirmation Dialog (REMOVED: The custom modal is no longer needed) -->
    <!-- The structure for customModal and its styles were removed from the HTML and CSS -->


    <script type="module">
        // --- Firebase Initialisierung (Zwingend erforderlich für Canvas) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let app;
        let auth;
        
        async function initFirebase() {
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const firebaseConfig = JSON.parse(configString);

                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } else {
                    console.warn("Firebase initialization failed: Running in offline mode.");
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        }
        
        // --- Global Variables (App State) ---
        let timeEntries = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentLanguage = 'de';
        let currentTheme = 'dark'; // Wird jetzt hauptsächlich über das synchrone Skript im <head> initialisiert
        let selectedFile = null; 
        
        // Constants for default fallback values
        const LEGACY_DEFAULT_HOURLY_RATE = 13.00;
        const LEGACY_DEFAULT_MINIJOB_LIMIT = 538.00;


        // --- Multilingual Data (Text IDs and Translations) ---
        const translations = {
            de: {
                appTitle: "MJZ",
                headerSubtitle: "Mini-Job Zeiterfassung", 
                cardTitleNewEntry: "Neue Arbeitszeit erfassen",
                labelDate: "Datum",
                labelStart: "Start",
                labelEnd: "Ende",
                btnAddEntry: "Zeiteintrag speichern",
                inputMessageError: "Ungültige Eingabe. Startzeit muss vor der Endzeit liegen oder die Dauer muss > 0 sein.",
                inputMessageOverlap: "Zeitüberschneidung. Der neue Eintrag überlappt mit einem bestehenden Eintrag.",
                settingsModalTitle: "Einstellungen & Tools",
                titleGeneralSettings: "Allgemeine Einstellungen",
                titleAppearanceLanguage: "Erscheinungsbild & Sprache",
                labelRate: "Aktueller Stundenlohn (€)",
                labelLimit: "Minijob-Verdienstobergrenze (€)", 
                labelLanguage: "Sprache",
                labelTheme: "Erscheinungsbild",
                themeLight: "Light Mode",
                themeDark: "Dark Mode",
                cardTitleDataTools: "Daten-Tools",
                btnExport: "Alle Einträge als CSV herunterladen",
                labelImport: "CSV Import (ersetzt aktuelle Daten)",
                btnImportAction: "Importieren", 
                titleDangerZone: "Gefahrenzone",
                btnDeleteAllData: "Alle Zeiteinträge löschen", 
                warningDeleteImmediate: "Achtung: Dieser Vorgang löscht alle Einträge sofort und unwiderruflich!",
                summaryTotalTime: "Gesamtzeit (Std)",
                summaryTotalEarnings: "Gesamtlohn (€)",
                summaryOvertime: "Überstunden (Std)",
                cardTitleEntries: "Zeiteinträge",
                loadingMessage: "Lade lokale Daten...",
                thDate: "Datum",
                thStart: "Start",
                thEnd: "End",
                thDurationHMM: "Dauer (H:MM)",
                thDurationDecimal: "Dauer (Dezimal)",
                thDelete: "Löschen",
                modalMessageImportSuccess: "Daten erfolgreich importiert. {count} Einträge geladen.",
                modalMessageImportError: "Fehler beim Import: Ungültiges CSV-Format oder leere Datei.",
                warningText: "Minijob-Obergrenze erreicht. Überstunden werden berechnet.",
                nextDayWarning: "Ende-Zeit ist am nächsten Tag.", 
                monthNames: ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"],
            },
            en: {
                appTitle: "MJZ",
                headerSubtitle: "Mini-Job Time Tracking", 
                cardTitleNewEntry: "Log New Work Time",
                labelDate: "Date",
                labelStart: "Start",
                labelEnd: "End",
                btnAddEntry: "Save Time Entry",
                inputMessageError: "Invalid input. Start time must be before end time or duration must be > 0.",
                inputMessageOverlap: "Time overlap. The new entry overlaps with an existing entry.",
                settingsModalTitle: "Settings & Tools",
                titleGeneralSettings: "General Settings",
                titleAppearanceLanguage: "Appearance & Language",
                labelRate: "Current Hourly Rate (€)",
                labelLimit: "Minijob Earning Limit (€)", 
                labelLanguage: "Language",
                labelTheme: "Appearance",
                themeLight: "Light Mode",
                themeDark: "Dark Mode",
                cardTitleDataTools: "Data Tools",
                btnExport: "Download All Entries as CSV",
                labelImport: "CSV Import (replaces current data)",
                btnImportAction: "Import", 
                titleDangerZone: "Danger Zone",
                btnDeleteAllData: "Delete All Time Entries", 
                warningDeleteImmediate: "Caution: This operation deletes all entries immediately and irrevocably!",
                summaryTotalTime: "Total Time (Hrs)",
                summaryTotalEarnings: "Total Earnings (€)",
                summaryOvertime: "Overtime (Hrs)",
                cardTitleEntries: "Time Entries",
                loadingMessage: "Loading local data...",
                thDate: "Date",
                thStart: "Start",
                thEnd: "End",
                thDurationHMM: "Duration (H:MM)",
                thDurationDecimal: "Duration (Decimal)",
                thDelete: "Delete",
                modalMessageImportSuccess: "Data successfully imported. {count} entries loaded.",
                modalMessageImportError: "Import error: Invalid CSV format or empty file.",
                warningText: "Minijob limit reached or exceeded. Overtime will be calculated.",
                nextDayWarning: "End time is on the next day.", 
                monthNames: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
            },
            fil: {
                appTitle: "MJZ",
                headerSubtitle: "Mini-Job Pagsubaybay sa Oras", 
                cardTitleNewEntry: "Mag-log ng Bagong Oras ng Trabaho",
                labelDate: "Petsa",
                labelStart: "Simula",
                labelEnd: "Pagtatapos",
                btnAddEntry: "I-save ang Pag-log ng Oras",
                inputMessageError: "Hindi wastong input. Ang oras ng simula ay dapat bago ang oras ng pagtatapos o ang tagal ay dapat > 0.",
                inputMessageOverlap: "Oras overlap. Ang bagong entry ay umaapaw sa isang umiiral nang entry.",
                settingsModalTitle: "Mga Setting at Kasangkupan",
                titleGeneralSettings: "Pangkalahatang Mga Setting",
                titleAppearanceLanguage: "Hitsura at Wika",
                labelRate: "Kasalukuyang Rate kada Oras (€)",
                labelLimit: "Limitasyon sa Kita ng Minijob (€)", 
                labelLanguage: "Wika",
                labelTheme: "Hitsura",
                themeLight: "Light Mode",
                themeDark: "Dark Mode",
                cardTitleDataTools: "Mga Kasangkupan sa Data",
                btnExport: "I-download ang Lahat ng Entries bilang CSV",
                labelImport: "CSV Import (papalit sa kasalukuyang data)",
                btnImportAction: "I-import", 
                titleDangerZone: "Mapanganib na Sona",
                btnDeleteAllData: "Tanggalin ang Lahat ng Time Entries", 
                warningDeleteImmediate: "Babala: Ang operasyon na ito ay agad at permanenteng tatanggalin ang lahat ng entries!",
                summaryTotalTime: "Kabuuang Oras (Oras)",
                summaryTotalEarnings: "Kabuuang Kita (€)",
                summaryOvertime: "Overtime (Oras)",
                cardTitleEntries: "Mga Log ng Oras",
                loadingMessage: "Naglo-load ng lokal na data...",
                thDate: "Petsa",
                thStart: "Simula",
                thEnd: "Pagtatapos",
                thDurationHMM: "Tagal (H:MM)",
                thDurationDecimal: "Tagal (Desimal)",
                thDelete: "Tanggalin",
                modalMessageImportSuccess: "Matagumpay na na-import ang data. {count} entries na-load.",
                modalMessageImportError: "Error sa Import: Hindi wasto ang CSV format o walang laman ang file.",
                warningText: "Naabot o nalampasan ang limitasyon ng Minijob. Kinakalkula ang Overtime.",
                nextDayWarning: "Ang oras ng pagtatapos ay sa susunod na araw.", 
                monthNames: ["Enero", "Pebrero", "Marso", "Abril", "Mayo", "Hunyo", "Hulyo", "Agosto", "Setyembre", "Oktubre", "Nobyembre", "Disyembre"],
            }
        };

        // --- Helper Functions ---
        
        // Sets the current time in the specified field (start or end)
        const setCurrentTime = (inputId) => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${hours}:${minutes}`;
            
            document.getElementById(inputId).value = currentTime;
        };

        // Function to format minutes in H:MM (e.g., 125 -> 2:05)
        const formatDurationHMM = (minutes) => {
            const h = Math.floor(minutes / 60);
            const mm = Math.floor(minutes % 60);
            return `${h}:${mm < 10 ? '0' : ''}${mm}`;
        };

        // Function to format minutes in decimal hours (e.g., 125 -> 2.08)
        const formatDurationDecimal = (minutes) => {
            return (minutes / 60).toFixed(2);
        };
        
        // Checks if the end time is before or equal to the start time (over midnight)
        const checkOverMidnight = () => {
            const startInput = document.getElementById('entryStartTime').value;
            const endInput = document.getElementById('entryEndTime').value;
            const warningElement = document.getElementById('nextDayWarning');
            
            // Hide warning by default
            warningElement.classList.add('hidden');
            
            if (startInput && endInput) {
                // Convert times to minutes since midnight
                const [startH, startM] = startInput.split(':').map(Number);
                const [endH, endM] = endInput.split(':').map(Number);
                
                const startMinutes = startH * 60 + startM;
                const endMinutes = endH * 60 + endM;
                
                // If end time <= start time, the entry goes over midnight
                if (endMinutes <= startMinutes) {
                    warningElement.textContent = translations[currentLanguage].nextDayWarning;
                    warningElement.classList.remove('hidden');
                }
            }
        };


        // Displays import/error messages
        const displayImportMessage = (type, data = null) => {
            const messageBox = document.getElementById('importMessage');
            messageBox.classList.remove('hidden');
            
            if (type === 'importSuccess') {
                messageBox.textContent = translations[currentLanguage].modalMessageImportSuccess.replace('{count}', data);
                messageBox.style.color = 'var(--color-success)';
            } else if (type === 'importError') {
                messageBox.textContent = translations[currentLanguage].modalMessageImportError;
                messageBox.style.color = 'var(--color-danger)';
            } else {
                 messageBox.classList.add('hidden');
            }
            
            // Hide message after 5 seconds
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        };

        // Function to update all texts based on the current language
        const updateTexts = () => {
            const texts = translations[currentLanguage];
            if (!texts) return;

            // Header and static titles
            document.getElementById('appTitle').textContent = texts.appTitle;
            document.getElementById('headerSubtitle').textContent = texts.headerSubtitle;
            document.getElementById('cardTitleNewEntry').textContent = texts.cardTitleNewEntry;
            document.getElementById('btnAddEntry').textContent = texts.btnAddEntry;
            document.getElementById('settingsModalTitle').textContent = texts.settingsModalTitle;
            document.getElementById('titleGeneralSettings').textContent = texts.titleGeneralSettings;
            document.getElementById('titleAppearanceLanguage').textContent = texts.titleAppearanceLanguage;
            document.getElementById('cardTitleDataTools').textContent = texts.cardTitleDataTools;
            document.getElementById('btnExport').textContent = texts.btnExport;
            document.getElementById('btnImportAction').textContent = texts.btnImportAction; 
            document.getElementById('titleDangerZone').textContent = texts.titleDangerZone;
            document.getElementById('btnDeleteAllData').textContent = texts.btnDeleteAllData; 
            document.getElementById('warningDeleteImmediate').textContent = texts.warningDeleteImmediate;
            document.getElementById('cardTitleEntries').textContent = texts.cardTitleEntries;
            document.getElementById('loadingMessage').textContent = texts.loadingMessage;
            document.getElementById('warningText').textContent = texts.warningText;

            // Labels
            document.getElementById('labelDate').textContent = texts.labelDate;
            document.getElementById('labelStart').textContent = texts.labelStart;
            document.getElementById('labelEnd').textContent = texts.labelEnd;
            document.getElementById('labelRate').textContent = texts.labelRate;
            document.getElementById('labelLimit').textContent = texts.labelLimit; 
            document.getElementById('labelLanguage').textContent = texts.labelLanguage;
            document.getElementById('labelTheme').textContent = texts.labelTheme;
            document.getElementById('labelImport').textContent = texts.labelImport;
            
            // Summary Labels
            document.getElementById('summaryTotalTime').textContent = texts.summaryTotalTime;
            document.getElementById('summaryTotalEarnings').textContent = texts.summaryTotalEarnings;
            document.getElementById('summaryOvertime').textContent = texts.summaryOvertime;

            // Table Headers
            document.getElementById('thDate').textContent = texts.thDate;
            document.getElementById('thStart').textContent = texts.thStart;
            document.getElementById('thEnd').textContent = texts.thEnd;
            document.getElementById('thDurationHMM').textContent = texts.thDurationHMM;
            document.getElementById('thDurationDecimal').textContent = texts.thDurationDecimal;
            document.getElementById('thDelete').textContent = texts.thDelete;

            // Theme Options
            document.getElementById('themeLight').textContent = texts.themeLight;
            document.getElementById('themeDark').textContent = texts.themeDark;
            
            // Update the over-midnight warning, if visible
            if (!document.getElementById('nextDayWarning').classList.contains('hidden')) {
                document.getElementById('nextDayWarning').textContent = texts.nextDayWarning;
            }

            // Since month names were translated, the table and month selection must be re-rendered
            renderTimeEntries();
        };

        // Function to save entries to LocalStorage
        const saveEntries = () => {
            localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
            renderTimeEntries();
        };

        // Function to load entries and settings from LocalStorage
        const loadData = () => {
            const today = new Date();
            
            // --- 1. Set Date and Month/Year Defaults ---
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            
            // Set date input field to today (YYYY-MM-DD format)
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('entryDate').value = todayStr;

            // --- 2. Load Entries ---
            const savedEntries = localStorage.getItem('timeEntries');
            if (savedEntries) {
                timeEntries = JSON.parse(savedEntries);
                
                // Ensure legacy entries have a rate field
                timeEntries = timeEntries.map(entry => {
                    if (typeof entry.rate === 'undefined') {
                         entry.rate = getCurrentHourlyRate() || LEGACY_DEFAULT_HOURLY_RATE;
                    }
                    // Ensure ID is a number (CRITICAL FIX for delete functionality)
                    if (typeof entry.id !== 'number') {
                        entry.id = Number(entry.id);
                    }
                    
                    // Remove old breaksMinutes field if it exists
                    const { breaksMinutes, ...rest } = entry;
                    return rest;
                });
                timeEntries.sort((a, b) => new Date(a.date + ' ' + a.start) - new Date(b.date + ' ' + b.start));
            } else {
                timeEntries = []; 
            }

            // --- 3. Load Settings ---
            document.getElementById('hourlyRate').value = localStorage.getItem('hourlyRate') || '';
            document.getElementById('minijobLimit').value = localStorage.getItem('minijobLimit') || '';


            const savedLang = localStorage.getItem('language');
            if (savedLang && translations[savedLang]) {
                currentLanguage = savedLang;
                document.getElementById('languageSelect').value = savedLang;
            }

            // The theme is already initialized synchronously in <head>, we just set the dropdown here
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light' || savedTheme === 'dark') {
                currentTheme = savedTheme;
            } else {
                // If not set, it defaults to 'dark' as defined in the synchronous script
                currentTheme = 'dark'; 
            }
            document.getElementById('themeSelect').value = currentTheme;
            
            // applyTheme(currentTheme); // We don't call this here anymore!
            updateTexts(); // Calls renderTimeEntries
        };

        // Function to apply the selected theme (only for runtime changes)
        const applyTheme = (theme) => {
            const html = document.documentElement;
            html.classList.remove('dark');

            if (theme === 'dark') {
                html.classList.add('dark');
            }
            
            localStorage.setItem('theme', theme);
            currentTheme = theme;
        };
        
        // Gets the current hourly rate, returns 0 if input is missing or invalid.
        const getCurrentHourlyRate = () => {
            const inputRate = document.getElementById('hourlyRate').value;
            const parsedRate = parseFloat(inputRate);
            return (parsedRate > 0) ? parsedRate : 0;
        };

        // Gets the current minijob limit, returns 0 if input is missing or invalid.
        const getCurrentMinijobLimit = () => {
            const inputLimit = document.getElementById('minijobLimit').value;
            const parsedLimit = parseFloat(inputLimit);
            return (parsedLimit > 0) ? parsedLimit : 0;
        };


        // Function to populate the month and year dropdowns
        const populateMonthYearSelects = () => {
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            const texts = translations[currentLanguage];

            // 1. Populate Month Dropdown
            monthSelect.innerHTML = '';
            texts.monthNames.forEach((monthName, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = monthName;
                monthSelect.appendChild(option);
            });

            // 2. Populate Year Dropdown
            yearSelect.innerHTML = '';
            const todayYear = new Date().getFullYear();
            let minYear = todayYear;

            if (timeEntries.length > 0) {
                timeEntries.forEach(entry => {
                    if (entry.date) {
                         const year = parseInt(entry.date.split('-')[0]);
                         if (year < minYear) {
                            minYear = year;
                         }
                    }
                });
            }
            
            // Add current year, previous years down to the minimum year found, and next year
            for (let year = todayYear + 1; year >= minYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            // 3. Set Dropdowns to current values
            monthSelect.value = currentMonth;
            yearSelect.value = currentYear;
        };

        // Function to change the displayed month and year via the dropdowns
        const selectMonthYear = () => {
            currentMonth = parseInt(document.getElementById('monthSelect').value);
            currentYear = parseInt(document.getElementById('yearSelect').value);
            renderTimeEntries();
        };


        // Function to calculate and display the monthly summary and table
        const renderTimeEntries = () => {
            const entryList = document.getElementById('timeEntryList');
            entryList.innerHTML = '';
            
            populateMonthYearSelects();

            const currentHourlyRate = getCurrentHourlyRate();
            const currentMinijobLimit = getCurrentMinijobLimit();
            
            const filteredEntries = timeEntries.filter(entry => {
                const parts = entry.date.split('-');
                // Note: Months are 0-indexed in JS Date, so parts[1]-1 is correct
                const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));

                return !isNaN(date.getTime()) && date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            // --- Logik für den leeren Zustand (WICHTIG für deleteAllTimeEntries) ---
            if (filteredEntries.length === 0) {
                entryList.innerHTML = `<tr><td colspan="6" class="text-center py-4" id="loadingMessage" style="color: var(--text-secondary);">${translations[currentLanguage].loadingMessage}</td></tr>`;
                
                // Aktualisiere alle Summary-Felder auf 0 oder Platzhalter
                document.getElementById('totalTimeHours').textContent = '0.00';
                
                // Zeigt '--' an, wenn kein Lohn/Limit gesetzt ist, sonst '0.00'
                const earningsPlaceholder = currentHourlyRate > 0 ? '0.00' : '--';
                document.getElementById('totalEarnings').textContent = earningsPlaceholder; 
                
                const overtimePlaceholder = currentMinijobLimit > 0 && currentHourlyRate > 0 ? '0.00' : '--';
                document.getElementById('overtimeHours').textContent = overtimePlaceholder;
                
                document.getElementById('minijobWarning').style.display = 'none';
                return;
            }

            // --- Calculation of Total Values for the Month (with capping) ---
            
            let monthlyTotalMinutes = 0;
            let overtimeHours = 0;
            let cumulativeEarnings = 0;

            const chronologicalEntries = [...filteredEntries].sort((a, b) => new Date(a.date + ' ' + a.start) - new Date(b.date + ' ' + b.start));

            const isPayCalculationActive = currentHourlyRate > 0;
            const isOvertimeCalculationActive = currentMinijobLimit > 0;

            for (const entry of chronologicalEntries) {
                const totalMinutes = entry.durationMinutes; 
                const decimalHours = totalMinutes / 60;
                // Use the rate saved with the entry, falling back to 0 if missing 
                const entryRate = entry.rate || 0; 
                
                let hoursOverLimit = 0;
                
                if (isPayCalculationActive && entryRate > 0) { 
                    
                    if (isOvertimeCalculationActive) {
                        
                        if (cumulativeEarnings < currentMinijobLimit) {
                            const remainingLimit = currentMinijobLimit - cumulativeEarnings;
                            const potentialEarnings = decimalHours * entryRate;

                            if (cumulativeEarnings + potentialEarnings <= currentMinijobLimit) {
                                cumulativeEarnings += potentialEarnings;
                            } else {
                                const paidEarnings = remainingLimit;
                                cumulativeEarnings = currentMinijobLimit;
                                
                                const hoursToLimit = paidEarnings / entryRate;
                                hoursOverLimit = decimalHours - hoursToLimit;
                            }
                        } else {
                            hoursOverLimit = decimalHours;
                        }
                    } else {
                        // No limit set -> calculate full pay, no overtime hours
                        cumulativeEarnings += decimalHours * entryRate;
                        hoursOverLimit = 0; 
                    }
                } else {
                    // Payment is NOT active (Rate == 0 or entryRate == 0).
                    if (isOvertimeCalculationActive) {
                        // If limit is set, but no pay, all time is treated as 'exceeding' the pay condition
                        // which results in all hours being counted as overtime for warning purposes.
                        hoursOverLimit = decimalHours;
                    } else {
                        hoursOverLimit = 0;
                    }
                }

                overtimeHours += hoursOverLimit;
                monthlyTotalMinutes += totalMinutes;

                // Create table row (for filtered entries)
                const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'UTC' };
                const parts = entry.date.split('-');
                // Note: parts[1] is 1-indexed month string. parts[1]-1 gives 0-indexed month number.
                const displayDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));

                const dateStr = displayDate.toLocaleDateString(currentLanguage, dateOptions);

                const newRow = entryList.insertRow();
                newRow.className = 'hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150';
                
                newRow.insertCell().textContent = dateStr;
                newRow.insertCell().textContent = entry.start;
                newRow.insertCell().textContent = entry.end;
                
                newRow.insertCell().textContent = formatDurationHMM(totalMinutes);
                newRow.insertCell().textContent = formatDurationDecimal(totalMinutes);

                // Delete button
                const deleteCell = newRow.insertCell();
                deleteCell.className = 'text-center';
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = translations[currentLanguage].thDelete;
                deleteBtn.className = 'text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-semibold text-sm transition-colors';
                // Pass the entry.id directly.
                deleteBtn.onclick = () => window.deleteEntry(entry.id); 
                deleteCell.appendChild(deleteBtn);
            }

            // --- Update Monthly Summary ---
            
            // Only display earnings if calculation is active
            const totalEarnings = isPayCalculationActive ? cumulativeEarnings.toFixed(2) : '--';
            const totalTimeHours = formatDurationDecimal(monthlyTotalMinutes);
            // Only display overtime hours if calculation is active AND pay calculation is active
            const totalOvertime = isOvertimeCalculationActive && isPayCalculationActive ? overtimeHours.toFixed(2) : '--';

            document.getElementById('totalTimeHours').textContent = totalTimeHours;
            document.getElementById('totalEarnings').textContent = totalEarnings;
            document.getElementById('overtimeHours').textContent = totalOvertime;

            // Show warning if limit is reached AND a limit is set AND pay calculation is active
            if (isOvertimeCalculationActive && isPayCalculationActive && cumulativeEarnings >= currentMinijobLimit) {
                document.getElementById('minijobWarning').style.display = 'block';
            } else {
                document.getElementById('minijobWarning').style.display = 'none';
            }
        };

        // Helper function to check for overlaps
        const checkOverlap = (newStart, newEnd) => {
            for (const existingEntry of timeEntries) {
                // Create start and end timestamps in milliseconds for comparison
                const existingStart = new Date(`${existingEntry.date}T${existingEntry.start}:00`).getTime();
                let existingEnd = new Date(`${existingEntry.date}T${existingEntry.end}:00`).getTime();
                
                // Handle entries that go over midnight (end is on the next day)
                const existingStartOnly = existingEntry.start.split(':').map(Number);
                const existingEndOnly = existingEntry.end.split(':').map(Number);
                
                if (existingEndOnly[0] * 60 + existingEndOnly[1] <= existingStartOnly[0] * 60 + existingStartOnly[1]) {
                     existingEnd += (24 * 60 * 60 * 1000); // Add 1 day
                }

                // Check for overlap: (newStart < existingEnd) AND (existingStart < newEnd)
                if (newStart < existingEnd && existingStart < newEnd) {
                    return true; // Overlap found
                }
            }
            return false; // No overlap
        }

        // Function to add a new time entry
        const addTimeEntry = () => {
            const dateInput = document.getElementById('entryDate').value;
            const startInput = document.getElementById('entryStartTime').value;
            const endInput = document.getElementById('entryEndTime').value;

            const messageBox = document.getElementById('inputMessage');
            messageBox.textContent = '';
            messageBox.classList.add('hidden');
            document.getElementById('nextDayWarning').classList.add('hidden');

            if (!dateInput || !startInput || !endInput) {
                messageBox.textContent = translations[currentLanguage].inputMessageError;
                messageBox.classList.remove('hidden');
                return;
            }

            const startDateTime = new Date(`${dateInput}T${startInput}:00`);
            let endDateTime = new Date(`${dateInput}T${endInput}:00`);
            
            const isNextDay = endDateTime <= startDateTime;
            if (isNextDay) {
                // Ensure date is incremented for calculation
                endDateTime.setDate(endDateTime.getDate() + 1);
            }

            const durationMs = endDateTime - startDateTime;
            const durationMinutes = Math.max(0, Math.round(durationMs / (1000 * 60)));

            if (durationMinutes <= 0) {
                messageBox.textContent = translations[currentLanguage].inputMessageError;
                messageBox.classList.remove('hidden');
                return;
            }

            const newEntryStartMs = startDateTime.getTime();
            const newEntryEndMs = endDateTime.getTime();

            if (checkOverlap(newEntryStartMs, newEntryEndMs)) {
                messageBox.textContent = translations[currentLanguage].inputMessageOverlap;
                messageBox.classList.remove('hidden');
                return;
            }

            const currentRate = getCurrentHourlyRate();

            const newEntry = {
                id: Date.now(), 
                date: dateInput,
                start: startInput,
                end: endInput,
                durationMinutes: durationMinutes,
                rate: currentRate // Save the current rate with the entry
            };

            timeEntries.push(newEntry);
            timeEntries.sort((a, b) => new Date(a.date + ' ' + a.start) - new Date(b.date + ' ' + b.start));
            
            // Set current view to the month of the new entry
            currentMonth = startDateTime.getMonth();
            currentYear = startDateTime.getFullYear();

            saveEntries();

            document.getElementById('entryStartTime').value = '';
            document.getElementById('entryEndTime').value = '';
            checkOverMidnight();

            document.getElementById('entryStartTime').focus();
        };

        // Function to delete an entry
        const deleteEntry = (id) => {
            const entryId = Number(id); 
            timeEntries = timeEntries.filter(entry => entry.id !== entryId);
            saveEntries(); 
        };
        
        // Function to delete ALL time entries from LocalStorage and reset the state
        const deleteAllTimeEntries = () => {
            console.log("Aktion: Alle Zeiteinträge löschen wird ausgeführt.");

            // 1. Entferne die Daten aus dem LocalStorage (inklusive Einstellungen als gute Praxis)
            localStorage.removeItem('timeEntries');
            localStorage.removeItem('hourlyRate'); 
            localStorage.removeItem('minijobLimit');
            
            // 2. Setze den In-Memory-Zustand zurück
            timeEntries = [];
            
            // 3. Setze die Summary-Anzeige explizit zurück (WICHTIG!)
            document.getElementById('totalTimeHours').textContent = '0.00';
            document.getElementById('totalEarnings').textContent = '--'; // Standardwert bei fehlender Rate
            document.getElementById('overtimeHours').textContent = '--'; // Standardwert bei fehlendem Limit
            document.getElementById('minijobWarning').style.display = 'none';

            // Failsafe: Leere die Tabelle sofort.
            document.getElementById('timeEntryList').innerHTML = '';
            
            // 4. Führe loadData erneut aus, um UI und month/year Selects zu aktualisieren
            loadData(); 
            
            // 5. Schließe das Einstellungs-Modal
            window.hideSettingsModal(); 
            
            console.log("Aktion: Alle Zeiteinträge gelöscht. Datenstand:", timeEntries.length);
        };

        // --- Modal Logic (Settings) ---

        const settingsModal = document.getElementById('settingsModal');

        const showSettingsModal = () => {
            settingsModal.style.display = 'flex';
        };
        
        const hideSettingsModal = () => {
            settingsModal.style.display = 'none';
        };

        // --- CSV Logic ---
        
        const csvHeader = ["ID", "Datum", "Startzeit", "Endzeit", "DauerMinuten", "RateEUR"];

        // Function to export entries as CSV
        const exportCSV = () => {
            if (timeEntries.length === 0) return;

            const csvData = timeEntries.map(entry => [
                entry.id,
                entry.date,
                entry.start,
                entry.end,
                entry.durationMinutes,
                (entry.rate || 0).toFixed(2) 
            ]);

            const csvArray = [csvHeader, ...csvData];
            const csvString = csvArray.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });

            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            
            const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            link.setAttribute("download", `MJZ_Export_${today}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // Process file selection and set button status
        const handleFileSelection = (event) => {
            const fileInput = event.target;
            const importBtn = document.getElementById('btnImportAction');
            
            if (fileInput.files.length > 0) {
                selectedFile = fileInput.files[0];
                importBtn.disabled = false;
                displayImportMessage('hide'); 
            } else {
                selectedFile = null;
                importBtn.disabled = true;
            }
        };

        // Function to import CSV data (uses the file stored in selectedFile)
        const importCSV = () => {
            if (!selectedFile) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvString = e.target.result;
                const lines = csvString.split('\n').filter(line => line.trim() !== '');
                const importBtn = document.getElementById('btnImportAction');
                
                importBtn.disabled = true;
                document.getElementById('csvFileInput').value = ''; 
                selectedFile = null;


                if (lines.length <= 1) {
                    displayImportMessage('importError'); 
                    return;
                }
                
                const importedEntries = [];
                const header = lines[0].split(',');
                
                // Assuming a minimum of 6 columns based on the csvHeader
                if (header.length < 6) { 
                    displayImportMessage('importError'); 
                    return;
                }

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length >= 6) { 
                        
                        const fallbackRate = getCurrentHourlyRate() || LEGACY_DEFAULT_HOURLY_RATE; 
                        
                        const entry = {
                            // Use || 0 to safely parse numbers
                            // Sicherstellen, dass ID immer als Zahl gespeichert wird
                            id: parseInt(values[0], 10) || Date.now() + i, 
                            date: values[1],
                            start: values[2],
                            end: values[3],
                            durationMinutes: parseInt(values[4], 10) || 0,
                            rate: parseFloat(values[5]) || fallbackRate 
                        };
                        
                        if (entry.date && entry.start && entry.end && entry.durationMinutes > 0) {
                            importedEntries.push(entry);
                        }
                    }
                    else {
                        console.warn(`Skipping malformed CSV line ${i}: ${lines[i]}`);
                    }
                }

                if (importedEntries.length > 0) {
                    timeEntries = importedEntries;
                    saveEntries();
                    displayImportMessage('importSuccess', importedEntries.length); 
                } else {
                    displayImportMessage('importError'); 
                }
            };
            reader.readAsText(selectedFile);
        };
        
        // --- Event Listeners and Initialization ---

        // Listener for settings (Rate, Limit, Language, Theme)
        document.getElementById('hourlyRate').addEventListener('change', (e) => {
            localStorage.setItem('hourlyRate', e.target.value);
            // We need to re-render to ensure new entries use the new rate, and existing calculations are updated.
            renderTimeEntries(); 
        });
        document.getElementById('minijobLimit').addEventListener('change', (e) => {
            localStorage.setItem('minijobLimit', e.target.value);
            renderTimeEntries();
        });
        
        document.getElementById('languageSelect').addEventListener('change', (e) => {
            currentLanguage = e.target.value;
            localStorage.setItem('language', currentLanguage);
            updateTexts();
        });
        
        document.getElementById('themeSelect').addEventListener('change', (e) => {
            // This applies the theme immediately and saves the preference
            applyTheme(e.target.value);
        });
        
        // --- CRITICAL FIX: Explicitly assign ALL functions used by inline onclick to the window object ---
        
        window.setCurrentTime = setCurrentTime;
        window.checkOverMidnight = checkOverMidnight;
        window.addTimeEntry = addTimeEntry;
        window.selectMonthYear = selectMonthYear;
        window.deleteEntry = deleteEntry; // For deleting single entries in the table
        
        // Modal functions
        window.showSettingsModal = showSettingsModal;
        window.hideSettingsModal = hideSettingsModal;
        
        // Final action function (now called directly)
        window.deleteAllTimeEntries = deleteAllTimeEntries; 
        
        // CSV functions
        window.exportCSV = exportCSV;
        window.handleFileSelection = handleFileSelection;
        window.importCSV = importCSV;


        // Start the App
        window.onload = async () => {
             await initFirebase(); // Initialize Firebase Auth
             loadData(); // Load local data and start app logic
        }
    </script>
</body>
</html>

